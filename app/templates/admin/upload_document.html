<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上传文档 - GxP Guider</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/alpinejs" defer></script>
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            background-color: #f8fafc;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #dbeafe;
            transform: scale(1.02);
        }
        
        .upload-area p {
            margin: 0;
            color: #64748b;
        }
        
        .upload-area .file-info {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .upload-input {
            display: none;
        }
        
        .result-box {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <a class="text-xl font-bold flex items-center" href="{{ url_for('main.index') }}">
                    <i class="fas fa-book-medical mr-2"></i>
                    <span>GxP Guider</span>
                </a>
                
                <div class="hidden md:flex items-center space-x-1">
                    <a class="px-3 py-2 rounded hover:bg-blue-700 transition duration-300" href="{{ url_for('main.index') }}">首页</a>
                    <a class="px-3 py-2 rounded hover:bg-blue-700 transition duration-300" href="{{ url_for('main.documents') }}">文档库</a>
                    
                    {% if current_user.is_authenticated %}
                        <a class="px-3 py-2 rounded hover:bg-blue-700 transition duration-300" href="{{ url_for('auth.profile') }}">个人中心</a>
                        {% if current_user.is_admin() %}
                        <a class="px-3 py-2 rounded hover:bg-blue-700 transition duration-300" href="/admin">管理后台</a>
                                                <a class="px-3 py-2 rounded hover:bg-blue-700 transition duration-300 bg-blue-700" href="{{ url_for('admin_panel.upload_document') }}">上传文档</a>
                        {% endif %}
                        <a class="px-3 py-2 rounded hover:bg-blue-700 transition duration-300" href="{{ url_for('auth.logout') }}">退出</a>
                    {% else %}
                        <a class="px-3 py-2 rounded hover:bg-blue-700 transition duration-300" href="{{ url_for('auth.login') }}">登录</a>
                        <a class="px-3 py-2 rounded bg-white text-blue-600 hover:bg-gray-100 transition duration-300" href="{{ url_for('auth.register') }}">注册</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">上传文档</h1>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="mb-4 p-4 rounded-lg {% if 'error' in category %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div id="error-box" class="hidden mb-4 p-4 rounded-lg bg-red-50 border border-red-200 text-red-700 text-sm"></div>
                <form id="upload-form" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">选择组织</label>
                            <select name="organization" id="organization" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">请选择组织</option>
                                {% for org in organizations %}
                                    <option value="{{ org.id }}">{{ org.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">选择分类</label>
                            <select name="category" id="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">请选择分类</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.id }}" data-org="{{ cat.org_id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">文档类型</label>
                            <div class="flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="document_type" value="original" class="text-blue-600" checked>
                                    <span class="ml-2">英文文档</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="document_type" value="translation" class="text-blue-600">
                                    <span class="ml-2">中文文档</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">文档标题</label>
                            <input type="text" name="title" id="title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入文档标题">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-2">选择文档文件</label>
                        <div class="upload-area" id="file-upload-area">
                            <p class="text-gray-600"><i class="fas fa-cloud-upload-alt text-3xl mb-2 block"></i> 将文档拖拽到这里或点击选择文件</p>
                            <p class="text-sm text-gray-500 mt-1">支持 PDF、Word 文档或压缩包（直接上传至对象存储）</p>
                            <div class="file-info" id="file-info"></div>
                        </div>
                        <input type="file" class="upload-input" id="document_file" name="document_file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.7z" required>
                        <div class="mt-2 h-2 bg-gray-200 rounded overflow-hidden"><div class="h-2 bg-blue-600" id="progress-bar" style="width:0%"></div></div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" id="submit-btn" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300">
                            <i class="fas fa-upload mr-2"></i>上传文档
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="result-section" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">上传结果</h2>
                <div class="result-box">
                    <p class="mb-2">文档已成功上传！</p>
                    <div class="flex items-center">
                        <input type="text" id="file-url" readonly class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none">
                        <button id="copy-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-r-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-copy mr-1"></i>复制
                        </button>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">点击复制按钮将文件路径复制到剪贴板</p>
                </div>
                <div class="mt-4">
                    <a href="{{ url_for('admin_panel.upload_document') }}" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition duration-300">
                        <i class="fas fa-plus mr-1"></i>继续上传
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 组织和分类的联动
            const organizationSelect = document.getElementById('organization');
            const categorySelect = document.getElementById('category');
            const categoryOptions = categorySelect.querySelectorAll('option[data-org]');
            
            organizationSelect.addEventListener('change', function() {
                const selectedOrgId = this.value;
                
                // 重置分类选择
                categorySelect.value = '';
                
                // 显示/隐藏对应组织的分类
                categoryOptions.forEach(option => {
                    if (selectedOrgId === '' || option.dataset.org === selectedOrgId) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            });
            
            // 文件拖拽上传功能
            const uploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('document_file');
            const fileInfo = document.getElementById('file-info');
            const submitBtn = document.getElementById('submit-btn');
            
            // 防止默认拖拽行为
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            // 高亮拖拽区域
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            // 处理文件拖拽
            uploadArea.addEventListener('drop', handleDrop, false);
            
            // 点击上传区域选择文件
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 处理文件选择
            fileInput.addEventListener('change', function() {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    fileInfo.textContent = file.name;
                } else {
                    fileInfo.textContent = '';
                }
            });
            
            // 表单提交处理（改为直接上传 R2）
            const form = document.getElementById('upload-form');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                const csrfToken = form.querySelector('input[name="csrf_token"]').value;
                const file = fileInput.files[0];
                const errBox = document.getElementById('error-box');
                // progress is already defined at top scope

                const showErr = (phase, msg, detail) => {
                    errBox.classList.remove('hidden');
                    errBox.innerHTML = `<strong>${phase}失败：</strong> ${msg || ''}${detail ? `<pre class="mt-2 whitespace-pre-wrap">${detail}</pre>` : ''}`;
                };

                errBox.classList.add('hidden');
                errBox.textContent = '';

                if (!file) { showErr('校验', '请选择文件'); return; }

                const orgId = organizationSelect.value;
                const categoryId = categorySelect.value;
                const docType = form.querySelector('input[name="document_type"]:checked').value;
                const title = document.getElementById('title').value || file.name;

                // 额外校验：分类需与所选组织匹配
                const selectedCat = categorySelect.options[categorySelect.selectedIndex];
                if (selectedCat && selectedCat.dataset.org && selectedCat.dataset.org !== orgId) {
                    showErr('校验', '所选分类不属于该组织，请重新选择');
                    return;
                }

                // 禁用提交按钮并显示加载状态
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>上传中...';

                try {
                    // 1) 请求预签名 URL
                    const presignRes = await fetch('{{ url_for("admin_panel.presign_upload") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({
                            organization_id: orgId,
                            document_type: docType,
                            title: title,
                            filename: file.name,
                            content_type: file.type || 'application/octet-stream'
                        })
                    });
                    if (!presignRes.ok) {
                        const t = await presignRes.text();
                        showErr('预签名', `HTTP ${presignRes.status} ${presignRes.statusText}`, t);
                        throw new Error('presign failed');
                    }
                    const sign = await presignRes.json();
                    if (!sign.url) { showErr('预签名', sign.error || '未返回 URL'); throw new Error('no url'); }

                    // 2) 使用 XMLHttpRequest 直传 R2（可获取上传进度）
                    await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('PUT', sign.url, true);
                        if (sign.content_type) xhr.setRequestHeader('Content-Type', sign.content_type);

                        // 进度条更新
                        progress.style.width = '0%';
                        xhr.upload.onprogress = (evt) => {
                            if (evt.lengthComputable) {
                                const percent = Math.round((evt.loaded / evt.total) * 100);
                                progress.style.width = percent + '%';
                            }
                        };

                        xhr.onerror = () => {
                            showErr('直传（PUT 到 R2）', '浏览器网络错误或被 CORS 拦截。请在 R2 桶 CORS 允许 http://127.0.0.1:5000 与你的站点域名，方法包含 PUT/GET/HEAD，且允许 Content-Type 头。');
                            reject(new Error('xhr error'));
                        };
                        xhr.onload = () => {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                progress.style.width = '100%';
                                resolve();
                            } else {
                                showErr('直传（PUT 到 R2）', `HTTP ${xhr.status} ${xhr.statusText}`, xhr.responseText || '');
                                reject(new Error('put failed'));
                            }
                        };
                        xhr.send(file);
                    });

                    // 3) 调用 finalize
                    const finRes = await fetch('{{ url_for("admin_panel.finalize_upload") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({
                            organization_id: orgId,
                            category_id: categoryId,
                            document_type: docType,
                            title: title,
                            key: sign.key
                        })
                    });
                    if (!finRes.ok) {
                        const t = await finRes.text();
                        showErr('Finalize', `HTTP ${finRes.status} ${finRes.statusText}`, t);
                        throw new Error('finalize http failed');
                    }
                    const data = await finRes.json();
                    if (!data.success) { showErr('Finalize', data.error || '接口返回失败'); throw new Error('finalize failed'); }

                    document.getElementById('file-url').value = data.file_url;
                    document.getElementById('result-section').classList.remove('hidden');
                    form.reset();
                    fileInfo.textContent = '';
                    progress.style.width = '0%';
                } catch (err) {
                    console.error(err);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>上传文档';
                }
            });
            
            // 复制文件路径功能
            const copyBtn = document.getElementById('copy-btn');
            const fileUrlInput = document.getElementById('file-url');

            copyBtn.addEventListener('click', async function() {
                try {
                    await navigator.clipboard.writeText(fileUrlInput.value);
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i>已复制';
                    setTimeout(() => { copyBtn.innerHTML = originalText; }, 2000);
                } catch (e) {
                    // 回退方案（某些环境不允许 clipboard API）
                    fileUrlInput.select();
                    const ok = document.execCommand('copy');
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = ok ? '<i class="fas fa-check mr-1"></i>已复制' : '<i class="fas fa-times mr-1"></i>复制失败';
                    setTimeout(() => { copyBtn.innerHTML = originalText; }, 2000);
                }
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInfo.textContent = files[0].name;
                }
            }

            // 进度条 DOM
            const progress = document.getElementById('progress-bar');
            fileInput.addEventListener('change', () => { progress.style.width = '0%'; });
        });
    </script>
</body>
</html>
